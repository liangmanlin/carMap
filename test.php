<?php
define('DS',86400);
include "db.class.php";

global $db;
$db = new DB();

$ak = "Vb06jHkPmvvc68aVmG2NbpcYIvu6v8OI";
$service_id = "126200";
$mcode = "9F:2E:6A:35:E8:06:54:2E:6C:03:51:1C:DD:0B:ED:78:4A:EA:C2:1B;com.example.manlin.carmap";
$entityName = "myCAMRY";

$dateStart = date("Y-m-d",time());
$dateEnd = date("Y-m-d",time());
if($_REQUEST['start'])
	$dateStart = $_REQUEST['start'];

if($_REQUEST['end'])
	$dateEnd = $_REQUEST['end'];

if($dateStart == date("Y-m-d",time())){
	$data = get_from_lbs();
}else{
	$tmp = array();
	if($dateEnd == date("Y-m-d",time())){
		$tmp = get_from_lbs();
		$dateEnd = date("Y-m-d",time()-DS);
	}
	$data = get_from_db($dateStart,$dateEnd);
	$data = array_merge($data,$tmp);
}
$len = count($data);
if($len > 10){
	$time1 = $data[0]['ltime'];
	$str = "";
	for($i=0;$i<$len;$i++){
		$v = $data[$i];
		$ltime= $v['ltime'];
		$endStr = "\n";
		if($v['count_time']){
			$t = $v['count_time'];
			$dist = $v['dist'];
			if($i<$len-1){
				$endStr = ",{$t},{$dist}#";
			}else{
				$endStr = ",{$t},{$dist}";
			}
		}
		$str.=$ltime.",".$v['x'].",".$v['y'].$endStr;
	}
	$str = trim($str,"\n");
	echo $str;
	die();
}


function get_from_db($dateStart,$dateEnd){
	global $db;
	$startTime = strtotime($dateStart." 4:00:00");
	$endTime = strtotime($dateEnd." 4:00:00")+DS;
	$a = date("Y_m",$startTime);
	$b = date("Y_m",strtotime($dateEnd." 4:00:00"));
	if($a==$b){
		$sql = "select * from history_{$a} where ltime >= {$startTime} and ltime <= {$endTime}";
		return $db->fetchAll($sql);
	}else{
		$sql = "select * from history_{$a} where ltime >= {$startTime} and ltime <= {$endTime}";
		$tmp = $db->fetchAll($sql);
		$sql = "select * from history_{$b} where ltime >= {$startTime} and ltime <= {$endTime}";
		return array_merge($tmp,$db->fetchAll($sql));
	}
	
}

function get_from_lbs(){
	$startTime = strtotime(date("Y-m-d",time())." 4:00:00");
	$endTime = $startTime+DS;
	
	global $ak,$mcode,$service_id,$entityName;  
	$url = "http://api.map.baidu.com/trace/v2/track/gethistory?ak={$ak}&mcode={$mcode}&service_id={$service_id}&entity_name={$entityName}&".
		"start_time={$startTime}&end_time={$endTime}&page_index=1&page_size=5000";
	$result = @ file_get_contents($url);
	$arr = json_decode($result,true);
	$points = array_reverse($arr['points']);
	$len = count($points);
	$time1 = $points[0]['loc_time'];
	$totalDist = $arr['distance']/1000;
	
	$tmpArr = array();
	for($i=0;$i<$len;$i++){
		$v = $points[$i];
		$p = $v['location'];
		$ltime= $v['loc_time'];
		if($i<$len-1){
			if(abs($ltime-$points[$i+1]['loc_time'])>40){
				$dist = get_dist($time1,$ltime);
				$t = $ltime-$time1;
				$time1 = $points[$i+1]['loc_time'];
				$tmpArr[] = array('ltime'=>$ltime,'x'=>$p[0],'y'=>$p[1],'count_time'=>$t,'dist'=>$dist);
			}else{
				$tmpArr[] = array('ltime'=>$ltime,'x'=>$p[0],'y'=>$p[1]);
			}
		}else {
			$dist = get_dist($time1,$ltime);
			$t = $ltime-$time1;
			$tmpArr[] = array('ltime'=>$ltime,'x'=>$p[0],'y'=>$p[1],'count_time'=>$t,'dist'=>$dist);
		}
	}
	return $tmpArr;
}

function get_dist($startTime,$endTime){
	global $ak,$mcode,$service_id,$entityName;
	$url = "http://api.map.baidu.com/trace/v2/track/gethistory?ak={$ak}&mcode={$mcode}&service_id={$service_id}&entity_name={$entityName}&".
		"start_time={$startTime}&end_time={$endTime}&simple_return=2";
	$result = @ file_get_contents($url);
	$arr = json_decode($result,true);
	return $arr['distance']/1000;
}
//echo "1475970446,113.423460744,23.1205286519
//1475970456,113.423460744,23.1205286519
//1475970466,113.423460744,23.1205286519
//1475970476,113.423247354,23.1206897096
//1475970486,113.423247354,23.1206897096
//1475970496,113.423247354,23.1206897096
//1475970506,113.422831464,23.1221686461
//1475970516,113.423506494,23.124484958
//1475970526,113.423945922,23.1243434748
//1475970536,113.425358132,23.1236124029
//1475970547,113.425865762,23.1233408937
//1475970557,113.426736575,23.1228472167
//1475970567,113.42761072,23.1223726761
//1475970577,113.42774421,23.1225720735
//1475970587,113.427286267,23.1228681881
//1475970597,113.426440725,23.1233503039
//1475970607,113.425987777,23.123592376
//1475970617,113.425249035,23.124033885
//1475970627,113.424343286,23.1245211833
//1475970637,113.423883953,23.1247064425
//1475970647,113.42388205,23.1247045706
//1475970657,113.423878783,23.1247081426
//1475970667,113.423875518,23.1247098159
//1475970677,113.423623285,23.1247982387
//1475970687,113.423098726,23.1249524639
//1475970697,113.422467031,23.125109573
//1475970708,113.421441541,23.1253300218
//1475970718,113.419774723,23.1256036392
//1475970728,113.418974767,23.1257430176
//1475970738,113.417620876,23.1259873061
//1475970748,113.416109673,23.1262098493
//1475970758,113.414614083,23.1263935379
//1475970768,113.413290786,23.1266192986
//1475970778,113.4120576,23.1270180244
//1475970788,113.4109945,23.1277548315
//1475970798,113.410205251,23.1285097693
//1475970808,113.409848118,23.1289408869
//1475970818,113.409496207,23.1292886021
//1475970828,113.408877176,23.1298956195
//1475970838,113.408251755,23.1304000367
//1475970848,113.407696227,23.1306525632
//1475970858,113.40699452,23.1309428677
//1475970868,113.40604745,23.1311379913
//1475970878,113.404842434,23.1311263226
//1475970889,113.403853811,23.1310153763
//1475970899,113.403653994,23.1309950802
//1475970909,113.40365562,23.1309967118
//1475970919,113.403658873,23.1309999752
//1475970929,113.403492408,23.1309846168
//1475970939,113.402967557,23.1309643472
//1475970949,113.402252759,23.1308896719
//1475970959,113.401271375,23.1308349972
//1475970969,113.400488494,23.1308440263
//1475970979,113.399422332,23.1308751473
//1475970989,113.398150235,23.1309555605
//1475970999,113.397371003,23.1310807565
//1475971009,113.396551809,23.1311701032
//1475971019,113.395716214,23.1312500674
//1475971029,113.394768934,23.1313166755
//1475971039,113.393618531,23.1313735739
//1475971049,113.393068021,23.1314484594
//1475971059,113.392275627,23.1315419319
//1475971070,113.391670029,23.1315955373
//1475971080,113.391012805,23.131654741
//1475971090,113.390878059,23.1316931421
//1475971100,113.390511738,23.1317078705
//1475971110,113.390210634,23.1317087426
//1475971120,113.389986099,23.1317070715
//1475971130,113.389706657,23.1317046171
//1475971140,113.388873239,23.1317654011
//1475971150,113.388382585,23.1318028471
//1475971160,113.388370684,23.1318026747
//1475971170,113.388219489,23.1318205503
//1475971180,113.387723721,23.131907656
//1475971190,113.38702002,23.1319814473
//1475971200,113.386559207,23.1320270162
//1475971210,113.385835845,23.132115291
//1475971220,113.3846515,23.1323816969
//1475971230,113.383863333,23.1326712249
//1475971241,113.382832151,23.1331411658
//1475971251,113.382474744,23.1333081751
//1475971261,113.382409861,23.1333336554
//1475971271,113.382404995,23.1333319451
//1475971281,113.382403103,23.1333286578
//1475971291,113.382397967,23.133330198
//1475971301,113.382394723,23.1333301428
//1475971311,113.3823931,23.1333349978
//1475971321,113.382386341,23.1333367816
//1475971331,113.382057064,23.1334705903
//1475971341,113.381187399,23.1338614186
//1475971351,113.380189648,23.1343227995
//1475971361,113.379313305,23.134833077
//1475971371,113.377996155,23.1355833413
//1475971382,113.377474232,23.1358602195
//1475971392,113.376454461,23.1364192586
//1475971402,113.375413629,23.1370175323
//1475971412,113.374587129,23.1374533873
//1475971422,113.374416045,23.1375469189
//1475971432,113.374385774,23.1375645563
//1475971442,113.374392531,23.1375614211
//1475971452,113.374374153,23.1375743869
//1475971462,113.374276314,23.1376342282
//1475971472,113.374171449,23.1377053394
//1475971482,113.374126584,23.1377330272
//1475971492,113.373943608,23.1378361228
//1475971502,113.373740628,23.1379206936
//1475971513,113.373476024,23.1380340222
//1475971523,113.373409806,23.1380645928
//1475971533,113.373371426,23.1380820912
//1475971543,113.37333656,23.1380999231
//1475971553,113.373173581,23.1381700247
//1475971563,113.3729906,23.1382549706
//1475971573,113.372707878,23.1383395302
//1475971583,113.372553002,23.1383916163
//1475971593,113.372065669,23.1385806038
//1475971603,113.371821322,23.1386661529
//1475971613,113.371661573,23.1386997371
//1475971623,113.371655086,23.1386979972
//1475971633,113.371492093,23.138741569
//1475971643,113.371343966,23.1387788926
//1475971654,113.371195839,23.1388246313
//1475971664,113.371044467,23.1388700488
//1475971674,113.370716583,23.1389821755
//1475971684,113.370487361,23.1390732202
//1475971694,113.370359233,23.139122317
//1475971704,113.370129735,23.1392098547
//1475971714,113.36994673,23.1392813715
//1475971724,113.36994673,23.1392813715
//1475971734,113.369939973,23.1392864121
//1475971744,113.369848335,23.1393247496
//1475971754,113.369564224,23.1394295875
//1475971764,113.369123312,23.1395682048
//1475971774,113.368397961,23.1397036024
//1475971785,113.367708802,23.1398414108
//1475971795,113.366793836,23.1400607951
//1475971805,113.366400942,23.1401173683
//1475971815,113.366016687,23.1401722475
//1475971825,113.365680283,23.14022168
//1475971835,113.365265983,23.140284932
//1475971845,113.364889524,23.1403306521
//1475971855,113.364230403,23.1403666918
//1475971865,113.363741104,23.1404056176
//1475971875,113.363421386,23.1404489161
//1475971885,113.363053233,23.1404932442
//1475971895,113.362627174,23.1405534301
//1475971905,113.362463778,23.1405743195
//1475971915,113.3620293,23.1406329266
//1475971926,113.361214928,23.1407544422
//1475971936,113.360868589,23.1408030848
//1475971946,113.360452147,23.140855858
//1475971956,113.36005731,23.1408371138
//1475971966,113.359755856,23.1409397189
//1475971976,113.35948766,23.140981452
//1475971986,113.359484413,23.1409830433
//1475971996,113.359339346,23.1409911937
//1475972006,113.359084398,23.1410361371
//1475972016,113.359069511,23.141035975
//1475972026,113.358964765,23.1410429773
//1475972036,113.35852818,23.1411094064
//1475972046,113.35810321,23.1411907474
//1475972056,113.357821686,23.1412457029
//1475972067,113.357546642,23.1412809794
//1475972077,113.356948605,23.1413895184
//1475972087,113.356721719,23.1414300331
//1475972097,113.356169904,23.1415277012
//1475972107,113.355735038,23.1416515371
//1475972117,113.355540072,23.1417164084
//1475972127,113.355264932,23.1417771518
//1475972137,113.354879823,23.1418582853
//1475972147,113.354652863,23.1419078698
//1475972157,113.354347883,23.1419618264
//1475972167,113.354074314,23.1420228596
//1475972177,113.353955952,23.1420768551
//1475972187,113.353759289,23.1421034883
//1475972197,113.353752789,23.1421083287
//1475972207,113.353742777,23.1421400034
//1475972218,113.353736014,23.1421684441
//1475972228,113.353699448,23.142188009
//1475972238,113.35341771,23.1422206601
//1475972248,113.353069032,23.1422380586
//1475972258,113.352656923,23.1422416428
//1475972268,113.352241504,23.1421650599
//1475972278,113.351977821,23.1421200344
//1475972288,113.351771038,23.1420802267
//1475972298,113.35158403,23.1420389213
//1475972308,113.351297273,23.1419752318
//1475972318,113.350913188,23.141886533
//1475972329,113.350816686,23.1418592908
//1475972339,113.350804755,23.1418440518
//1475972349,113.350679792,23.1418183378
//1475972359,113.3504163,23.1417584939
//1475972369,113.349877077,23.1416357038
//1475972379,113.349379558,23.1415268543
//1475972389,113.348913717,23.1414193876
//1475972399,113.348698408,23.1413687488
//1475972409,113.348516447,23.1413312351
//1475972419,113.348371093,23.1413073776
//1475972429,113.348142473,23.1412551998
//1475972439,113.347867192,23.1411840226
//1475972449,113.347621732,23.1411216264
//1475972459,113.347357818,23.1410576446
//1475972469,113.347155463,23.1409986436
//1475972479,113.346993521,23.1409581438
//1475972489,113.34653778,23.1408506258
//1475972500,113.346318839,23.1407684528
//1475972510,113.345619059,23.1403741191
//1475972520,113.345167807,23.1402354394
//1475972530,113.344700227,23.1400568276
//1475972540,113.344248891,23.1398851658
//1475972550,113.343973137,23.1398000671
//1475972560,113.343807912,23.1400619895
//1475972570,113.343625905,23.1405089974
//1475972580,113.343450631,23.1407525564
//1475972590,113.343298365,23.1407741652
//1475972600,113.343243257,23.1407529015
//1475972610,113.343405068,23.1408861595
//1475972621,113.343405068,23.1408861595
//1475972631,113.343251688,23.1408125578,2185,10.2835068504#1476013090,113.343638622,23.1403559601
//1476013100,113.343638622,23.1403559601
//1476013110,113.343638622,23.1403559601
//1476013120,113.343638622,23.1403559601
//1476013130,113.343638622,23.1403559601
//1476013141,113.343640529,23.1403817267
//1476013151,113.343640529,23.1403817267
//1476013161,113.343647557,23.1402658706
//1476013171,113.343647557,23.1402658706
//1476013181,113.343647557,23.1402658706
//1476013191,113.343647557,23.1402658706
//1476013201,113.343647557,23.1402658706
//1476013211,113.343647557,23.1402658706
//1476013221,113.343647557,23.1402658706
//1476013231,113.343647557,23.1402658706
//1476013241,113.343647557,23.1402658706
//1476013251,113.343666559,23.14028074
//1476013262,113.343666559,23.14028074
//1476013272,113.343666559,23.14028074
//1476013282,113.343666559,23.14028074
//1476013292,113.343567283,23.1405270628
//1476013302,113.343567283,23.1405270628
//1476013312,113.343567283,23.1405270628
//1476013322,113.342856661,23.143039739
//1476013332,113.342872662,23.1430011613
//1476013342,113.342856661,23.143039739
//1476013352,113.342813256,23.1431131364
//1476013362,113.342813256,23.1431131364
//1476013372,113.342813256,23.1431131364
//1476013382,113.34245803,23.1462722816
//1476013393,113.34245803,23.1462722816
//1476013403,113.342891921,23.1486899138
//1476013413,113.342891921,23.1486899138
//1476013423,113.342891921,23.1486899138
//1476013433,113.342863798,23.1488549624
//1476013443,113.342863798,23.1488549624
//1476013453,113.342863798,23.1488549624
//1476013463,113.338983931,23.1501932529
//1476013473,113.339063434,23.1511892275
//1476013483,113.339140542,23.1514990851
//1476013493,113.339373205,23.1520379945
//1476013503,113.339609438,23.1526241385
//1476013514,113.339785783,23.1530449286
//1476013524,113.340274734,23.1537919276
//1476013534,113.340552502,23.1540443167
//1476013544,113.3412761,23.1539285161
//1476013554,113.342380857,23.1535840135
//1476013564,113.343321502,23.153305944
//1476013574,113.34415182,23.1530533462
//1476013584,113.344881628,23.1528248708
//1476013594,113.345908621,23.1525087636
//1476013604,113.346870317,23.1521936187
//1476013614,113.348214159,23.1518003642
//1476013624,113.349948017,23.1513627388
//1476013634,113.3516882,23.1510725146
//1476013644,113.353289421,23.1508275645
//1476013654,113.355111774,23.1506383733
//1476013664,113.356838887,23.1505826922
//1476013675,113.358530391,23.1506256212
//1476013685,113.36029972,23.1507500434
//1476013695,113.361893829,23.1508858057
//1476013705,113.364003402,23.1509864897
//1476013715,113.364904022,23.1509308223
//1476013725,113.366566648,23.1505736276
//1476013735,113.368250287,23.1500927284
//1476013745,113.369727218,23.1496824614
//1476013755,113.371468622,23.1492310724
//1476013765,113.373427902,23.1486130804
//1476013775,113.375358091,23.1478749673
//1476013785,113.377268243,23.1470995425
//1476013795,113.379250076,23.1463171118
//1476013805,113.381170426,23.1455493643
//1476013816,113.383127478,23.1447865475
//1476013826,113.384873134,23.1440869186
//1476013836,113.386832143,23.1433529919
//1476013846,113.388655038,23.1428149239
//1476013856,113.39030335,23.1424460234
//1476013866,113.391747479,23.1421572776
//1476013876,113.393325031,23.1417924104
//1476013886,113.394959264,23.1414127465
//1476013896,113.396520551,23.141058588
//1476013906,113.398157264,23.1406547256
//1476013916,113.400050474,23.1401817518
//1476013926,113.401854365,23.1397448463
//1476013937,113.40352738,23.1393412675
//1476013947,113.40593565,23.1387325028
//1476013957,113.40677926,23.1385423844
//1476013967,113.408331476,23.1381444043
//1476013977,113.410079053,23.1376716611
//1476013987,113.411779151,23.1372462804
//1476013997,113.412893384,23.1369686939
//1476014007,113.414340349,23.136580803
//1476014017,113.415718938,23.1362199174
//1476014027,113.417109538,23.1358671272
//1476014037,113.418520028,23.1355028443
//1476014047,113.419991195,23.135101111
//1476014057,113.421374016,23.134740472
//1476014067,113.422678487,23.1344048545
//1476014077,113.423477171,23.13411677
//1476014087,113.423799317,23.1337053955
//1476014098,113.42361391,23.1329093998
//1476014108,113.423453886,23.131907973
//1476014118,113.423831459,23.1309140017
//1476014128,113.424060466,23.130200371
//1476014138,113.424204303,23.1296249109
//1476014148,113.424154481,23.1289770708
//1476014158,113.423687214,23.1280318567
//1476014168,113.423394994,23.1269539292
//1476014178,113.423430932,23.1258212882
//1476014188,113.423397792,23.1252366909
//1476014198,113.42339265,23.1251884821
//1476014208,113.423389387,23.1251868996
//1476014218,113.423267441,23.124845193
//1476014228,113.422895344,23.1238949712
//1476014238,113.422799397,23.122522757
//1476014249,113.422968803,23.1210618218
//1476014259,113.423007705,23.1206894474
//1476014269,113.42301778,23.1206757497
//1476014279,113.423026053,23.1205256512
//1476014289,113.423109996,23.1203126859
//1476014299,113.423168389,23.1204320419
//1476014309,113.423126101,23.1209642162
//1476014319,113.423095587,23.1214032014
//1476014329,113.423062252,23.121610328
//1476014339,113.423175583,23.1217522635
//1476014349,113.423598314,23.1217545784
//1476014360,113.423803791,23.121629931
//1476014370,113.423835643,23.121597751
//1476014380,113.423472161,23.121655702
//1476014390,113.423472161,23.121655702
//1476014400,113.424107431,23.1215795419,1310,12.6521825721";